name: Build and Netlify Deploy

on:
  pull_request:
    branches:
    - theme_updates
  push:
    branches:
    - theme_updates
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GH_TOKEN: ${{ secrets.GH_PAT != '' && secrets.GH_PAT || secrets.GITHUB_TOKEN }}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: Checkout current branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}
        token: ${{ env.GH_TOKEN }}
        submodules: 'true'

    - name: Display branch information
      run: |
        echo "Running on branch: ${{ github.head_ref }}"
        echo "Target branch: ${{ github.base_ref }}"
        echo "PR number: ${{ github.event.number }}"
        echo "Commit SHA: ${{ github.sha }}"


    - uses: actions/setup-node@v4
      with:
        node-version: 18.x

    - name: Install MyST Markdown CLI
      run: |
        npm install -g mystmd thebe-core thebe thebe-lite

    - name: Build HTML
      working-directory: ./lectures
      run: |
        myst build --html

    - name: Upload build output
      uses: actions/upload-pages-artifact@v3
      with:
        path: './lectures/_build/html'

    - name: Preview Deploy to Netlify
      uses: nwtgck/actions-netlify@v3
      with:
        publish-dir: './lectures/_build/html'
        production-branch: main
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: "Preview Deploy from GitHub Actions"
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
